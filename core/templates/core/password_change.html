{% extends 'base2.html' %}
{% load widget_tweaks %}
{% block title %}Trocar Senha{% endblock %}

{% block content %}
<style>
  .page-shell{min-height:65vh}
  .auth-hero{background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%); color:#fff; border-radius:1rem}
  .strength-bar{height:6px;border-radius:6px;background:#e9ecef;overflow:hidden}
  .strength-fill{height:100%;width:0;transition:width .25s ease}
  .strength-weak{background:#dc3545}
  .strength-ok{background:#fd7e14}
  .strength-good{background:#ffc107}
  .strength-strong{background:#28a745}
  .caps-hint{display:none}
  .form-control.is-invalid + .invalid-feedback{display:block}
</style>

<div class="container page-shell py-5 mt-5">
  <div class="row g-4 align-items-stretch">
    <div class="col-12 col-lg-5">
      <div class="auth-hero h-100 p-4 p-lg-5 shadow-sm">
        <h2 class="fw-bold mb-2">Trocar Senha</h2>
        <p class="mb-4 opacity-75">Por segurança, confirme sua senha atual e defina uma nova senha forte.</p>
        <ul class="mb-4 small">
          <li>Use 8+ caracteres</li>
          <li>Misture letras maiúsculas e minúsculas</li>
          <li>Inclua números e símbolos</li>
          <li>Evite informações óbvias</li>
        </ul>
        <div class="small opacity-75">
          Precisa de ajuda?
          <a class="link-light text-decoration-underline" href="{% url 'esqueci_senha_email' %}">Recuperar por e-mail</a> •
          <a class="link-light text-decoration-underline" href="{% url 'esqueci_senha_cpf' %}">Recuperar pelo CPF</a>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-7">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body p-4 p-lg-5">
          {% if messages %}
            {% for m in messages %}
              <div class="alert alert-{{ m.tags }} mb-4" role="alert">{{ m }}</div>
            {% endfor %}
          {% endif %}

          <form method="post" novalidate>
            {% csrf_token %}

            <div class="mb-3">
              <label class="form-label fw-semibold" for="{{ form.old_password.id_for_label }}">Senha atual</label>
              <div class="input-group">
                {{ form.old_password|add_class:"form-control"|attr:"autocomplete:current-password" }}
                <button class="btn btn-outline-secondary" type="button" data-toggle="pw"
                        aria-label="Mostrar/ocultar senha atual">
                  <i class="bi bi-eye"></i>
                </button>
              </div>
              <div class="form-text caps-hint" id="caps-old">Caps Lock ativado</div>
              {% if form.old_password.errors %}
                <div class="invalid-feedback d-block">{{ form.old_password.errors|join:", " }}</div>
              {% endif %}
            </div>

            <div class="mb-3">
              <label class="form-label fw-semibold" for="{{ form.new_password1.id_for_label }}">Nova senha</label>
              <div class="input-group">
                {{ form.new_password1|add_class:"form-control"|attr:"autocomplete:new-password" }}
                <button class="btn btn-outline-secondary" type="button" data-toggle="pw"
                        aria-label="Mostrar/ocultar nova senha">
                  <i class="bi bi-eye"></i>
                </button>
              </div>
              <div class="form-text caps-hint" id="caps-new1">Caps Lock ativado</div>

              <div class="strength-bar mt-2" aria-hidden="true">
                <div id="pw-strength" class="strength-fill"></div>
              </div>
              <div id="pw-hint" class="small text-muted mt-1">Força da senha: —</div>

              {% if form.new_password1.errors %}
                <div class="invalid-feedback d-block">{{ form.new_password1.errors|join:", " }}</div>
              {% endif %}
            </div>

            <div class="mb-4">
              <label class="form-label fw-semibold" for="{{ form.new_password2.id_for_label }}">Confirmar nova senha</label>
              <div class="input-group">
                {{ form.new_password2|add_class:"form-control"|attr:"autocomplete:new-password" }}
                <button class="btn btn-outline-secondary" type="button" data-toggle="pw"
                        aria-label="Mostrar/ocultar confirmação de senha">
                  <i class="bi bi-eye"></i>
                </button>
              </div>
              <div class="form-text caps-hint" id="caps-new2">Caps Lock ativado</div>
              {% if form.new_password2.errors %}
                <div class="invalid-feedback d-block">{{ form.new_password2.errors|join:", " }}</div>
              {% endif %}
            </div>

            <div class="d-grid d-sm-flex gap-2">
              <button id="submit-btn" type="submit" class="btn btn-primary btn-lg">
                <span class="spinner-border spinner-border-sm me-2 d-none" aria-hidden="true"></span>
                Atualizar senha
              </button>
              <a href="{% url 'perfil' %}" class="btn btn-outline-secondary btn-lg">Cancelar</a>
            </div>
          </form>

          <hr class="my-4">
          <div class="small">
            Esqueceu a senha? Você pode
            <a href="{% url 'esqueci_senha_email' %}">receber um link por e-mail</a> ou
            <a href="{% url 'esqueci_senha_cpf' %}">validar pelo CPF</a>.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<script>
(function(){
  document.querySelectorAll('button[data-toggle="pw"]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const input = btn.previousElementSibling; 
      if (!input) return;
      const isText = input.getAttribute('type') === 'text';
      input.setAttribute('type', isText ? 'password' : 'text');
      btn.innerHTML = isText ? '<i class="bi bi-eye"></i>' : '<i class="bi bi-eye-slash"></i>';
    });
  });

  function wireCaps(inputSelector, hintId){
    const inp  = document.querySelector(inputSelector);
    const hint = document.getElementById(hintId);
    if (!inp || !hint) return;
    ['keydown','keyup'].forEach(evt=>{
      inp.addEventListener(evt, e=>{
        const caps = e.getModifierState && e.getModifierState('CapsLock');
        hint.style.display = caps ? 'block' : 'none';
      });
    });
  }
  wireCaps('input[name="{{ form.old_password.name }}"]','caps-old');
  wireCaps('input[name="{{ form.new_password1.name }}"]','caps-new1');
  wireCaps('input[name="{{ form.new_password2.name }}"]','caps-new2');

  const pw   = document.querySelector('input[name="{{ form.new_password1.name }}"]');
  const bar  = document.getElementById('pw-strength');
  const hint = document.getElementById('pw-hint');

  function scorePassword(s){
    s = (s||'').trim();
    let score = 0;
    if (s.length >= 8) score += 1;
    if (/[A-Z]/.test(s) && /[a-z]/.test(s)) score += 1;
    if (/\d/.test(s)) score += 1;
    if (/[^\w\s]/.test(s)) score += 1;
    if (s.length >= 12) score += 1;
    return Math.min(score, 4);
  }

  function renderStrength(val){
    const widths = ['10%','35%','60%','85%','100%'];
    const texts  = ['Muito fraca','Fraca','OK','Boa','Forte'];
    const classes= ['strength-weak','strength-weak','strength-ok','strength-good','strength-strong'];
    bar.className = 'strength-fill ' + classes[val];
    bar.style.width = widths[val];
    hint.textContent = 'Força da senha: ' + texts[val];
  }

  if (pw && bar && hint){
    pw.addEventListener('input', ()=> renderStrength(scorePassword(pw.value)));
    renderStrength(0);
  }

  const submit = document.getElementById('submit-btn');
  if (submit){
    submit.closest('form').addEventListener('submit', ()=>{
      const spinner = submit.querySelector('.spinner-border');
      if (spinner){ spinner.classList.remove('d-none'); }
      submit.setAttribute('disabled','disabled');
    });
  }
})();
</script>
{% endblock %}