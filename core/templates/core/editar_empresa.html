{% extends 'base2.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Editar: {{ empresa.nome }}{% endblock %}

{% block content %}
<style>
  .hero{background:linear-gradient(135deg,#f8f9fa,#eef4ff);border-bottom:1px solid #e9ecef}
  .section-card{border-radius:14px; box-shadow:0 8px 24px rgba(0,0,0,.06);}
  .form-hint{font-size:.9rem;color:#6c757d}
  .img-fit{max-height:260px; object-fit:cover}
  .badge-muted{background:#e9ecef;color:#495057}
</style>

<header class="hero py-4 mt-5" style="margin-top: 100px !important;">
  <div class="container d-flex justify-content-between align-items-center gap-3">
    <nav aria-label="breadcrumb" class="m-0">
      <ol class="breadcrumb m-0">
        <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
        <li class="breadcrumb-item"><a href="{% url 'suas_empresas' %}">Suas empresas</a></li>
        <li class="breadcrumb-item active" aria-current="page">Editar</li>
      </ol>
    </nav>
    <div class="d-flex align-items-center gap-2">
      <a class="btn btn-outline-secondary" href="{% url 'empresa_detalhe' empresa.id %}">Ver página</a>
    </div>
  </div>
</header>

<main class="container py-5" style="margin-top: 150px !important">
  <h1 class="h3 fw-bold mb-3">Editar: {{ empresa.nome }}</h1>
  <p class="text-muted">Atualize as informações exibidas no catálogo. Campos com * são obrigatórios.</p>

  {% if form.errors or form.non_field_errors %}
  <div class="alert alert-danger" role="alert">
    <div class="fw-semibold mb-2">Corrija os campos abaixo:</div>
    <ul class="mb-0">
      {% for field in form %}
        {% for e in field.errors %}
          <li><strong>{{ field.label }}:</strong> {{ e }}</li>
        {% endfor %}
      {% endfor %}
      {% for e in form.non_field_errors %}
        <li>{{ e }}</li>
      {% endfor %}
    </ul>
  </div>
{% endif %}

  <form id="empresa-form" method="POST" enctype="multipart/form-data" novalidate>
    {% csrf_token %}
    <div class="row g-4">

      <!-- Coluna principal -->
      <div class="col-lg-8">
        <div class="section-card bg-white p-4">
          <h2 class="h5 fw-bold mb-3">Informações gerais</h2>
          <div class="row g-3">
            <div class="col-md-8">
              <label class="form-label">Nome *</label>
              {{ form.nome|add_class:"form-control"|attr:"placeholder:Nome da empresa" }}
            </div>
            <div class="col-md-4">
              <label class="form-label">Categoria *</label>
              {{ form.categoria|add_class:"form-select" }}
            </div>

            <div class="col-12">
              <label class="form-label">Descrição</label>
              {{ form.descricao|add_class:"form-control"|attr:"rows:4"|attr:"placeholder:Conte sobre o local, serviços, diferenciais..." }}
              <div class="form-hint mt-1">Se vazio, uma descrição padrão pode ser aplicada.</div>
            </div>
          </div>
        </div>

        <div class="section-card bg-white p-4 mt-4">
          <h2 class="h5 fw-bold mb-3">Endereço e contato</h2>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Rua</label>
              {{ form.rua|add_class:"form-control" }}
            </div>
            <div class="col-md-3">
              <label class="form-label">Número</label>
              {{ form.numero|add_class:"form-control" }}
            </div>
            <div class="col-md-3">
              <label class="form-label">CEP</label>
              {{ form.cep|add_class:"form-control"|attr:"placeholder:Apenas números" }}
            </div>
            <div class="col-md-6">
              <label class="form-label">Bairro</label>
              {{ form.bairro|add_class:"form-control" }}
            </div>
            <div class="col-md-6">
              <label class="form-label">Cidade</label>
              {{ form.cidade|add_class:"form-control" }}
            </div>

            <div class="col-md-6">
              <label class="form-label">Telefone</label>
              {{ form.telefone|add_class:"form-control"|attr:"placeholder:48912345678" }}
              <div class="form-check mt-1">
                {{ form.sem_telefone|add_class:"form-check-input" }}
                <label class="form-check-label" for="{{ form.sem_telefone.id_for_label }}">Sem telefone</label>
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label">E-mail</label>
              {{ form.email|add_class:"form-control"|attr:"placeholder:contato@exemplo.com" }}
              <div class="form-check mt-1">
                {{ form.sem_email|add_class:"form-check-input" }}
                <label class="form-check-label" for="{{ form.sem_email.id_for_label }}">Sem e-mail</label>
              </div>
            </div>
          </div>
        </div>

        <div class="section-card bg-white p-4 mt-4">
          <h2 class="h5 fw-bold mb-3">Presença digital</h2>
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">Site</label>
              {{ form.site|add_class:"form-control"|attr:"placeholder:https://..." }}
            </div>
            <div class="col-md-6">
              <label class="form-label">Facebook</label>
              {{ form.facebook|add_class:"form-control"|attr:"placeholder:https://facebook.com/..." }}
            </div>
            <div class="col-md-6">
              <label class="form-label">Instagram</label>
              {{ form.instagram|add_class:"form-control"|attr:"placeholder:https://instagram.com/..." }}
            </div>
          </div>
        </div>

        <div class="section-card bg-white p-4 mt-4">
          <h2 class="h5 fw-bold mb-3">Imagem</h2>
          <div class="row g-3">
            <div class="col-md-6">
              <div class="border rounded p-2 h-100">
                <div class="fw-semibold mb-2">Atual</div>
                <img class="img-fluid rounded img-fit"
                     src="{% if form.instance and form.instance.imagem %}{{ form.instance.imagem.url }}{% else %}{% static 'images/sem_imagem.png' %}{% endif %}"
                     alt="Imagem atual da empresa">
              </div>
            </div>
            <div class="col-md-6">
              <div class="border rounded p-2 h-100">
                <div class="fw-semibold mb-2">Nova (pré-visualização)</div>
                <img id="img-preview" class="img-fluid rounded img-fit"
                     src="{% static 'images/sem_imagem.png' %}"
                     alt="Pré-visualização">
                <div class="mt-2">
                  {{ form.imagem|add_class:"form-control form-control-sm" }}
                  <div class="form-hint">A imagem só muda ao salvar.</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        {{ form.latitude }} {{ form.longitude }}

        <div class="section-card bg-white p-4 mt-4">
          <h2 class="h5 fw-bold mb-3">Localização</h2>
          <div id="map" style="height:380px;border-radius:10px;background:#e5e7eb;" aria-label="Mapa de seleção"></div>
          <div class="form-hint mt-2">Clique no mapa para ajustar a posição. Setas movem o marcador finamente.</div>
        </div>

        <div class="d-flex gap-2 mt-4">
          <button type="submit" class="btn btn-primary btn-lg">Salvar alterações</button>
          <a href="{% url 'suas_empresas' %}" class="btn btn-outline-secondary btn-lg">Cancelar</a>
        </div>
      </div>

      <!-- Coluna lateral com metadados -->
      <aside class="col-lg-4">
        <div class="section-card bg-white p-4">
          <h2 class="h6 fw-bold">Resumo</h2>
          <div class="small text-muted">ID #{{ empresa.id }}</div>
          <div class="mt-2"><span class="badge badge-muted">Categoria</span> {{ empresa.categoria.nome }}</div>
          <div class="mt-2"><span class="badge badge-muted">Cidade</span> {{ empresa.cidade|default:"—" }}</div>
          <div class="mt-2"><span class="badge badge-muted">Telefone</span> {{ empresa.telefone|default:"—" }}</div>
          <hr>
          <div class="small text-muted">Proprietário: {{ empresa.user.username }}</div>
          <div class="small text-muted">Atualizado em: {{ empresa.atualizado_em|default:empresa.data_cadastro|date:"d/m/Y H:i" }}</div>
        </div>
      </aside>
    </div>
  </form>
</main>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
(function(){
  // Pré-visualização da nova imagem
  const file = document.querySelector('input[type="file"][name$="imagem"]');
  const prev = document.getElementById('img-preview');
  if (file && prev){
    file.addEventListener('change', function(){
      const f = this.files && this.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = e => prev.src = e.target.result;
      reader.readAsDataURL(f);
    });
  }

  // Mapa
  const mapEl = document.getElementById('map');
  if (mapEl && window.L){
    const latInput = document.getElementById('id_latitude');
    const lngInput = document.getElementById('id_longitude');
    const DEF = {lat:-28.937100, lng:-49.484000};
    let lat = parseFloat(latInput?.value); if (Number.isNaN(lat)) lat = DEF.lat;
    let lng = parseFloat(lngInput?.value); if (Number.isNaN(lng)) lng = DEF.lng;

    const map = L.map(mapEl, {keyboard:true}).setView([lat,lng], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap'}).addTo(map);
    const marker = L.marker([lat,lng], {keyboard:true}).addTo(map);

    function update(ll){ if(latInput) latInput.value = ll.lat.toFixed(6); if(lngInput) lngInput.value = ll.lng.toFixed(6); }
    map.on('click', e => { marker.setLatLng(e.latlng); update(e.latlng); });
    mapEl.addEventListener('keydown', e=>{
      const step=0.0005, p=marker.getLatLng(); let h=true;
      if(e.key==='ArrowUp') marker.setLatLng([p.lat+step,p.lng]);
      else if(e.key==='ArrowDown') marker.setLatLng([p.lat-step,p.lng]);
      else if(e.key==='ArrowLeft') marker.setLatLng([p.lat,p.lng-step]);
      else if(e.key==='ArrowRight') marker.setLatLng([p.lat,p.lng+step]);
      else h=false;
      if(h){ update(marker.getLatLng()); e.preventDefault(); }
    });
    setTimeout(()=>map.invalidateSize(),0);
  }

  // Envio AJAX opcional (ative adicionando data-ajax="1" no <form>)
  const form = document.getElementById('empresa-form');
  if (form && form.dataset.ajax === "1"){
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(form);
      const resp = await fetch(form.action || location.href, {
        method:'POST',
        body: fd,
        headers: {
          'X-Requested-With':'XMLHttpRequest',
          'Accept':'application/json'
        }
      });

      if (resp.redirected){ location.href = resp.url; return; }

      const ct = resp.headers.get('content-type') || '';
      if (ct.includes('application/json')){
        const data = await resp.json();
        if (resp.ok && data.ok !== false){
          location.href = data.redirect_url || "{% url 'suas_empresas' %}";
        } else {
          document.getElementById('form-errors').innerHTML = data.html || `<div class="alert alert-danger">${data.error||'Erro ao salvar.'}</div>`;
        }
      } else {
        // Só lemos UMA vez: texto puro
        const html = await resp.text();
        document.getElementById('form-errors').innerHTML =
          '<div class="alert alert-danger">Erro ao processar a resposta do servidor.</div>';
        console.warn('Resposta não JSON:', html);
      }
    });
  }
})();
</script>
{% endblock %}
