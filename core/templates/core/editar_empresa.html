{% extends 'base2.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Editar: {{ empresa.nome }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages/editar_empresa.css' %}">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
{% endblock %}

{% block content %}

<header class="hero-bar py-4 mt-5" style="margin-top: 65px !important;">
  <div class="container d-flex justify-content-between align-items-center gap-3">
    <nav aria-label="breadcrumb" class="m-0">
      <ol class="breadcrumb m-0">
        <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
        <li class="breadcrumb-item"><a href="{% url 'suas_empresas' %}">Suas empresas</a></li>
        <li class="breadcrumb-item active" aria-current="page">Editar</li>
      </ol>
    </nav>
    <div class="d-flex align-items-center gap-2">
      <a class="btn btn-outline-themed" href="{% url 'empresa_detalhe' empresa.slug %}">Ver página</a>

      <form id="delete-empresa-form" action="{% url 'deletar_empresa' empresa.slug %}" method="POST" class="d-inline">
        {% csrf_token %}
        <button type="submit" class="btn btn-danger">
          <i class="bi bi-trash"></i> Excluir Empresa
        </button>
      </form>
    </div>
  </div>
</header>

<main class="container py-5" style="margin-top: 150px !important">
  <h1 class="h3 fw-bold mb-3">Editar: {{ empresa.nome }}</h1>
  <p class="text-muted">Atualize as informações exibidas no catálogo. Campos com * são obrigatórios.</p>

  {% if form.errors or form.non_field_errors %}
  <div class="alert alert-danger" role="alert">
    <div class="fw-semibold mb-2">Corrija os campos abaixo:</div>
    <ul class="mb-0">
      {% for field in form %}
      {% for e in field.errors %}
      <li><strong>{{ field.label }}:</strong> {{ e }}</li>
      {% endfor %}
      {% endfor %}
      {% for e in form.non_field_errors %}
      <li>{{ e }}</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <form id="empresa-form" method="POST" enctype="multipart/form-data" novalidate>
    {% csrf_token %}
    <div class="row g-4">

      <div class="col-lg-8">
        <div class="section-card bg-white p-4">
          <h2 class="h5 fw-bold mb-3">Informações gerais</h2>
          <div class="row g-3">
            <div class="col-md-8">
              <label class="form-label">Nome *</label>
              {{ form.nome|add_class:"form-control"|attr:"placeholder:Nome da empresa" }}
            </div>
            <div class="col-md-4">
              <div class="col-12">
                <label class="form-label fw-semibold">{{ form.tags.label }}</label>
                <div class="tag-checkbox-container p-2 border rounded">
                  {{ form.tags }}
                </div>
                <small class="text-muted">Selecione uma ou mais tags para esta empresa.</small>
              </div>
            </div>

            <div class="col-12">
              <label class="form-label">Descrição</label>
              {{ form.descricao|add_class:"form-control"|attr:"rows:4"|attr:"placeholder:Conte sobre o local, serviços,
              diferenciais..." }}
              <div class="form-hint mt-1">Se vazio, uma descrição padrão pode ser aplicada.</div>
            </div>
          </div>
        </div>

        <div class="section-card bg-white p-4 mt-4">
          <h2 class="h5 fw-bold mb-3">Endereço e contato</h2>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Rua</label>
              {{ form.rua|add_class:"form-control" }}
            </div>
            <div class="col-md-3">
              <label class="form-label">Número</label>
              {{ form.numero|add_class:"form-control" }}
            </div>
            <div class="col-md-3">
              <label class="form-label">CEP</label>
              {{ form.cep|add_class:"form-control"|attr:"placeholder:Apenas números" }}
            </div>
            <div class="col-md-6">
              <label class="form-label">Bairro</label>
              {{ form.bairro|add_class:"form-control" }}
            </div>
            <div class="col-md-6">
              <label class="form-label">Cidade</label>
              {{ form.cidade|add_class:"form-control" }}
            </div>

            <div class="col-md-6">
              <label class="form-label">Telefone</label>
              {{ form.telefone|add_class:"form-control"|attr:"placeholder:48912345678" }}
              <div class="form-check mt-1">
                {{ form.sem_telefone|add_class:"form-check-input" }}
                <label class="form-check-label" for="{{ form.sem_telefone.id_for_label }}">Sem telefone</label>
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label">E-mail</label>
              {{ form.email|add_class:"form-control"|attr:"placeholder:contato@exemplo.com" }}
              <div class="form-check mt-1">
                {{ form.sem_email|add_class:"form-check-input" }}
                <label class="form-check-label" for="{{ form.sem_email.id_for_label }}">Sem e-mail</label>
              </div>
            </div>
          </div>
        </div>

        <div class="section-card bg-white p-4 mt-4">
          <h2 class="h5 fw-bold mb-3">Presença digital</h2>
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">Site</label>
              {{ form.site|add_class:"form-control"|attr:"placeholder:https://..." }}
            </div>
            <div class="col-md-6">
              <label class="form-label">Facebook</label>
              {{ form.facebook|add_class:"form-control"|attr:"placeholder:https://facebook.com/..." }}
            </div>
            <div class="col-md-6">
              <label class="form-label">Instagram</label>
              {{ form.instagram|add_class:"form-control"|attr:"placeholder:https://instagram.com/..." }}
            </div>
          </div>
        </div>

        <div class="section-card bg-white p-4 mt-4">
          <h2 class="h5 fw-bold mb-3">Galeria de Imagens</h2>
          
          <div class="row g-3 mb-4" id="image-gallery-container">
              {% for imagem in empresa.imagens.all %}
              <div class="col-md-4 col-sm-6" id="imagem-card-{{ imagem.id }}">
                  <div class="card h-100">
                      <img src="{{ imagem.imagem.url }}" class="card-img-top" style="aspect-ratio: 4/3; object-fit: cover;" alt="Imagem da galeria">
                      <div class="card-body text-center p-2">
                          <div class="form-check">
                              <input class="form-check-input" type="radio" name="imagem_principal" id="principal-{{ imagem.id }}" value="{{ imagem.id }}" {% if imagem.principal %}checked{% endif %}>
                              <label class="form-check-label" for="principal-{{ imagem.id }}">
                                  Principal
                              </label>
                          </div>
                      </div>
                      <div class="card-footer p-2">
                          <button type="button" class="btn btn-sm btn-outline-danger w-100 btn-delete-image" data-imagem-id="{{ imagem.id }}" data-csrf="{{ csrf_token }}">
                              <i class="bi bi-trash"></i> Deletar
                          </button>
                      </div>
                  </div>
              </div>
              {% empty %}
              <div class="col-12">
                  <p class="text-muted">Nenhuma imagem na galeria ainda.</p>
              </div>
              {% endfor %}
          </div>

          <div>
              <label for="{{ form.novas_imagens.id_for_label }}" class="form-label">Adicionar novas imagens</label>
              {{ form.novas_imagens|add_class:"form-control"|attr:"multiple:true" }}
              <small class="form-text text-muted">Você pode selecionar múltiplos arquivos.</small>
          </div>
      </div>

        {{ form.latitude }} {{ form.longitude }}

        <div class="section-card bg-white p-4 mt-4">
          <h2 class="h5 fw-bold mb-3">Localização</h2>
          <div id="map" style="height:380px;border-radius:10px;background:#e5e7eb;" aria-label="Mapa de seleção"></div>
          <div class="form-hint mt-2">Clique no mapa para ajustar a posição. Setas movem o marcador finamente.</div>
        </div>

        <div class="d-flex gap-2 mt-4">
          <button type="submit" class="btn btn-primary btn-lg">Salvar alterações</button>
          <a href="{% url 'suas_empresas' %}" class="btn btn-outline-secondary btn-lg">Cancelar</a>
        </div>
      </div>

      <aside class="col-lg-4">
        <div class="section-card bg-white p-4">
          <h2 class="h6 fw-bold">Resumo</h2>
          <div class="small text-muted">ID #{{ empresa.slug }}</div>
          <div class="mt-2"><span class="badge badge-muted">Categoria</span> {{ empresa.categoria.nome }}</div>
          <div class="mt-2"><span class="badge badge-muted">Cidade</span> {{ empresa.cidade|default:"—" }}</div>
          <div class="mt-2"><span class="badge badge-muted">Telefone</span> {{ empresa.telefone|default:"—" }}</div>
          <hr>
          <div class="small text-muted">Proprietário: {{ empresa.user.username }}</div>
          <div class="small text-muted">Atualizado em: {{ empresa.atualizado_em|default:empresa.data_cadastro|date:"d/m/Y H:i" }}</div>
        </div>

        
        <div class="section-card bg-white p-4 mt-4">
          <h2 class="h5 fw-bold mb-3">Moderar Avaliações (<span id="review-count">{{ empresa.avaliacoes.count }}</span>)</h2>
          <div id="review-list-moderation">
              {% for avaliacao in empresa.avaliacoes.all %}
                <div class="d-flex gap-3 {% if not forloop.last %}mb-4 pb-4 border-bottom{% endif %}" id="review-card-{{ avaliacao.id }}">
                  <div class="flex-grow-1">
                    <div class="d-flex justify-content-between align-items-start">
                      <div>
                        <span class="fw-bold">{{ avaliacao.user.perfil.display_name|default:avaliacao.user.username }}</span>
                        <div class="star-rating-display text-warning">
                          {% for i in "12345"|make_list %}<i class="bi {% if forloop.counter <= avaliacao.nota %}bi-star-fill{% else %}bi-star{% endif %}"></i>{% endfor %}
                        </div>
                      </div>
                      <button type="button" class="btn btn-sm btn-outline-danger btn-delete-review" data-url="{% url 'deletar_avaliacao' avaliacao.id %}" title="Remover esta avaliação">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                    <p class="mb-1 mt-2 fst-italic">"{{ avaliacao.comentario|linebreaksbr|default:"Nenhum comentário." }}"</p>
                    <small class="text-muted">{{ avaliacao.data_criacao|date:"d M, Y" }}</small>
                  </div>
                </div>
              {% empty %}
                <p class="text-muted">Esta empresa ainda não recebeu nenhuma avaliação.</p>
              {% endfor %}
            </div>
        </div>


      </aside>
    </div>
  </form>
</main>

{% block extra_js %}
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="{% static 'js/site/editar_empresa.js' %}"></script>
{% endblock %}

{% endblock %}