{% extends 'base2.html' %}
{% load static %}
{% block title %}Esqueci minha senha (CPF){% endblock %}

{% block content %}
<div class="container py-5 mt-5">
  <div class="row justify-content-center">
    <div class="col-12 col-md-8 col-lg-6">
      <!-- header -->
      <div class="text-center mb-4">
        <div class="mb-2">
          <img src="{% static 'images/id_card.svg' %}" alt="" style="height:64px; opacity:.9;">
        </div>
        <h3 class="fw-bold mb-1">Redefinir senha via CPF</h3>
        <p class="text-muted m-0">
          Se o CPF/CNPJ existir e estiver vinculado a um e-mail, enviaremos um link de redefinição.
        </p>
      </div>

      <!-- alerts -->
      {% if messages %}
        {% for m in messages %}
          <div class="alert alert-{{ m.tags }} shadow-sm" role="alert">{{ m }}</div>
        {% endfor %}
      {% endif %}

      <!-- form -->
      <form method="post" class="card border-0 shadow-sm p-4">
        {% csrf_token %}
        {{ form.non_field_errors }}

        <div class="mb-3">
          <label for="{{ form.cpf_cnpj.id_for_label }}" class="form-label fw-semibold">CPF/CNPJ</label>
          {{ form.cpf_cnpj }}
          {% if form.cpf_cnpj.errors %}
            <div class="invalid-feedback d-block">{{ form.cpf_cnpj.errors.0 }}</div>
          {% else %}
            <div class="form-text">Digite apenas números — a formatação é aplicada automaticamente.</div>
          {% endif %}
        </div>

        <div class="d-grid d-sm-flex gap-2">
          <button class="btn btn-primary flex-fill" type="submit">
            Enviar link de redefinição
          </button>
          <a class="btn btn-outline-secondary" href="{% url 'login' %}">Voltar</a>
        </div>
      </form>

      <div class="text-center mt-3">
        <a class="small" href="{% url 'esqueci_senha_email' %}">
          Prefere usar seu e-mail?
        </a>
      </div>
    </div>
  </div>
</div>

<!-- melhora inputs sem depender de widget_tweaks -->
<script>
(function(){
  const inp = document.querySelector('input[name="cpf_cnpj"]');
  if (inp){
    inp.classList.add('form-control', 'form-control-lg');
    inp.setAttribute('inputmode', 'numeric');
    inp.setAttribute('autocomplete', 'off');
    inp.placeholder = 'Digite seu CPF ou CNPJ';

    // máscara leve (só aparência; servidor valida de verdade)
    function numbersOnly(v){ return (v || '').replace(/\D+/g,''); }
    function formatCpfCnpj(v){
      const n = numbersOnly(v);
      if (n.length <= 11){
        // CPF: 000.000.000-00
        return n
          .replace(/^(\d{3})(\d)/, '$1.$2')
          .replace(/^(\d{3})\.(\d{3})(\d)/, '$1.$2.$3')
          .replace(/^(\d{3})\.(\d{3})\.(\d{3})(\d)/, '$1.$2.$3-$4')
          .slice(0, 14);
      } else {
        // CNPJ: 00.000.000/0000-00
        return n
          .replace(/^(\d{2})(\d)/, '$1.$2')
          .replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3')
          .replace(/^(\d{2})\.(\d{3})\.(\d{3})(\d)/, '$1.$2.$3/$4')
          .replace(/^(\d{2})\.(\d{3})\.(\d{3})\/(\d{4})(\d)/, '$1.$2.$3/$4-$5')
          .slice(0, 18);
      }
    }
    inp.addEventListener('input', function(e){
      const cur = this.selectionStart;
      const before = this.value;
      this.value = formatCpfCnpj(this.value);
      // tentativa simples de manter o cursor em posição aceitável
      const delta = this.value.length - before.length;
      this.setSelectionRange(cur + (delta > 0 ? 1 : 0), cur + (delta > 0 ? 1 : 0));
    });
  }
})();
</script>
{% endblock %}