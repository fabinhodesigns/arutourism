{% extends 'base2.html' %}
{% load widget_tweaks %}
{% load form_helpers %}
{% load static %}

{% block title %}Cadastrar Empresa{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages/cadastrar_empresa.css' %}">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
{% endblock %} 

{% block content %}
<div id="notification-container" aria-live="polite" aria-atomic="true"></div>

<div class="container py-5 mt-5">
  <div class="row justify-content-center">
    <div class="col-lg-10 col-md-11 col-12">

      <h3 class="text-center fw-bold mb-4">Cadastro de Empresas</h3>

      <ul class="nav nav-tabs justify-content-center mb-4" id="cadTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="tab-individual" data-bs-toggle="tab" data-bs-target="#pane-individual" type="button" role="tab" aria-controls="pane-individual" aria-selected="true">
            Cadastro Individual
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-arquivo" data-bs-toggle="tab" data-bs-target="#pane-arquivo" type="button" role="tab" aria-controls="pane-arquivo" aria-selected="false">
            Cadastro com Arquivo
          </button>
        </li>
      </ul>

      <div class="tab-content">

        <div class="tab-pane fade show active" id="pane-individual" role="tabpanel" aria-labelledby="tab-individual">
          <div class="card card-clean p-4 bg-white">

            {% if form.errors %}
            <div id="errors-from-server" class="mb-3" role="alert" aria-live="assertive">
              <div class="message-box">
                <h5 class="mb-2">Por favor, corrija os seguintes erros:</h5>
                <ul class="m-0">
                  {% for field, error_list in form.errors.items %}
                    {% for error in error_list %}
                      <li>{% if field != '__all__' %}<strong>{{ form|get_field_verbose_name:field }}:</strong>{% endif %} {{ error }}</li>
                    {% endfor %}
                  {% endfor %}
                </ul>
              </div>
            </div>
            {% endif %}

            <form id="empresa-form" method="POST" enctype="multipart/form-data" novalidate>
              {% csrf_token %}
              <div class="row g-3">

                <div class="col-md-6">
                  <label for="{{ form.nome.id_for_label }}" class="form-label fw-semibold">Nome da Empresa</label>
                  {{ form.nome|add_class:"form-control form-control-lg"|attr:"autocomplete:organization" }}
                </div>

                <div class="col-md-6">
                  <label for="{{ form.categoria.id_for_label }}" class="form-label fw-semibold">Categoria</label>
                  {{ form.categoria|add_class:"form-select form-select-lg" }}
                </div>

                <div class="col-12">
                  <label for="{{ form.descricao.id_for_label }}" class="form-label fw-semibold">Descrição</label>
                  {{ form.descricao|add_class:"form-control form-control-lg"|attr:"rows:3" }}
                  <small class="text-muted">Se deixar em branco, colocaremos uma descrição padrão automaticamente.</small>
                </div>

                <div class="col-md-6">
                  <label for="{{ form.rua.id_for_label }}" class="form-label fw-semibold">Rua</label>
                  {{ form.rua|add_class:"form-control form-control-lg"|attr:"autocomplete:address-line1" }}
                </div>
                <div class="col-md-6">
                  <label for="{{ form.bairro.id_for_label }}" class="form-label fw-semibold">Bairro</label>
                  {{ form.bairro|add_class:"form-control form-control-lg"|attr:"autocomplete:address-level3" }}
                </div>

                <div class="col-md-6">
                  <label for="{{ form.cidade.id_for_label }}" class="form-label fw-semibold">Cidade</label>
                  {{ form.cidade|add_class:"form-control form-control-lg"|attr:"autocomplete:address-level2" }}
                </div>
                <div class="col-md-3">
                  <label for="{{ form.numero.id_for_label }}" class="form-label fw-semibold">Número</label>
                  {{ form.numero|add_class:"form-control form-control-lg"|attr:"inputmode:numeric" }}
                </div>
                <div class="col-md-3">
                  <label for="{{ form.cep.id_for_label }}" class="form-label fw-semibold">CEP</label>
                  {{ form.cep|add_class:"form-control form-control-lg"|attr:"inputmode:numeric" }}
                </div>

                <div class="col-md-6">
                  <label for="{{ form.telefone.id_for_label }}" class="form-label fw-semibold">Telefone</label>
                  {{ form.telefone|add_class:"form-control form-control-lg"|attr:"inputmode:tel" }}
                  <div class="form-check form-check-inline mt-1">
                    {{ form.sem_telefone|add_class:"form-check-input" }}
                    <label class="form-check-label" for="{{ form.sem_telefone.id_for_label }}">Sem Telefone</label>
                  </div>
                </div>

                <div class="col-md-6">
                  <label for="{{ form.email.id_for_label }}" class="form-label fw-semibold">Email de Contato</label>
                  {{ form.email|add_class:"form-control form-control-lg"|attr:"inputmode:email" }}
                  <div class="form-check form-check-inline mt-1">
                    {{ form.sem_email|add_class:"form-check-input" }}
                    <label class="form-check-label" for="{{ form.sem_email.id_for_label }}">Sem Email</label>
                  </div>
                </div>

                <div class="col-12">
                  <label for="{{ form.site.id_for_label }}" class="form-label fw-semibold">Site (opcional)</label>
                  {{ form.site|add_class:"form-control form-control-lg"|attr:"inputmode:url" }}
                </div>

                <div class="col-12">
                    <label for="{{ form.imagem_inicial.id_for_label }}" class="form-label fw-semibold">Imagem da Empresa</label>
                    <div class="preview-wrap">
                        <img id="img-preview" src="{% static 'core/images/sem_imagem.png' %}" alt="Pré-visualização da imagem" />
                        {{ form.imagem_inicial|add_class:"form-control form-control-sm" }}
                    </div>
                    <small class="form-text text-muted fst-italic mt-1">
                        Esta será a imagem principal. Você poderá adicionar mais imagens na galeria após o cadastro.
                    </small>
                </div>

                {{ form.latitude }} {{ form.longitude }}

                <div class="col-md-6">
                  <label for="{{ form.facebook.id_for_label }}" class="form-label fw-semibold">Facebook (opcional)</label>
                  {{ form.facebook|add_class:"form-control form-control-lg"|attr:"inputmode:url" }}
                </div>
                <div class="col-md-6">
                  <label for="{{ form.instagram.id_for_label }}" class="form-label fw-semibold">Instagram (opcional)</label>
                  {{ form.instagram|add_class:"form-control form-control-lg"|attr:"inputmode:url" }}
                </div>

                {% if form.fields.cnpj or form.fields.cadastrur or form.fields.digital or form.fields.maps_url or form.fields.app_url or form.fields.endereco_full %}
                <div class="col-12">
                  <hr class="my-3" aria-hidden="true">
                  <h5 class="fw-semibold mb-2">Dados avançados</h5>
                </div>
                {% if form.fields.cnpj %}
                <div class="col-md-4">
                  <label for="{{ form.cnpj.id_for_label }}" class="form-label fw-semibold">CNPJ</label>
                  {{ form.cnpj|add_class:"form-control form-control-lg"|attr:"inputmode:numeric" }}
                </div>
                {% endif %}
                {% if form.fields.cadastrur %}
                <div class="col-md-4">
                  <label for="{{ form.cadastrur.id_for_label }}" class="form-label fw-semibold">Cadastur</label>
                  {{ form.cadastrur|add_class:"form-control form-control-lg" }}
                </div>
                {% endif %}
                {% if form.fields.endereco_full %}
                <div class="col-md-4">
                  <label for="{{ form.endereco_full.id_for_label }}" class="form-label fw-semibold">Endereço completo</label>
                  {{ form.endereco_full|add_class:"form-control form-control-lg" }}
                </div>
                {% endif %}
                {% if form.fields.digital %}
                <div class="col-md-6">
                  <label for="{{ form.digital.id_for_label }}" class="form-label fw-semibold">Digital (site/redes)</label>
                  {{ form.digital|add_class:"form-control form-control-lg"|attr:"inputmode:url" }}
                </div>
                {% endif %}
                {% if form.fields.maps_url %}
                <div class="col-md-6">
                  <label for="{{ form.maps_url.id_for_label }}" class="form-label fw-semibold">Google Maps (link)</label>
                  {{ form.maps_url|add_class:"form-control form-control-lg"|attr:"inputmode:url" }}
                </div>
                {% endif %}
                {% if form.fields.app_url %}
                <div class="col-md-6">
                  <label for="{{ form.app_url.id_for_label }}" class="form-label fw-semibold">App (link)</label>
                  {{ form.app_url|add_class:"form-control form-control-lg"|attr:"inputmode:url" }}
                </div>
                {% endif %}
                {% endif %}

                <div class="col-12 mt-3">
                  <label class="form-label fw-semibold">Selecione a localização no mapa</label>
                  <div id="map" style="height: 380px; border-radius: 10px;"></div>
                </div>
              </div>

              <div class="d-flex flex-column flex-md-row gap-3 justify-content-center mt-4">
                <button type="submit" name="save" class="btn btn-primary btn-lg rounded-3 fw-semibold px-4">Salvar</button>
                <button type="submit" name="save_and_add" class="btn btn-outline-secondary btn-lg rounded-3 fw-semibold px-4">Salvar e Continuar</button>
              </div>
            </form>
          </div>
        </div>

        <div class="tab-pane fade" id="pane-arquivo" role="tabpanel" aria-labelledby="tab-arquivo">
          <div class="card card-clean p-4 bg-white">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
              <h5 class="mb-0 fw-bold">Importar empresas por arquivo (.xlsx / .csv)</h5>
              <a class="btn btn-outline-secondary btn-sm" href="{% url 'download_template_empresas' %}">
                Baixar modelo (.xlsx)
              </a>
            </div>

            <p class="text-muted mb-3">
              Preencha o arquivo seguindo os cabeçalhos do modelo. Campos vazios serão preenchidos com valores padrão
              (ex.: descrição). A categoria será criada automaticamente se não existir.
            </p>

            <form id="form-import" method="post" enctype="multipart/form-data" action="{% url 'importar_empresas_arquivo' %}">
              {% csrf_token %}
              <div id="drop" class="import-drop" role="region" aria-label="Envio de arquivo por arrastar e soltar">
                <input id="arquivo" name="arquivo" type="file" accept=".xlsx,.csv" hidden>
                <p class="mb-2">Arraste e solte seu arquivo aqui, ou</p>
                <button type="button" id="btn-select" class="btn btn-secondary">Selecionar arquivo</button>
                <div id="fn" class="mt-2 small text-muted" aria-live="polite"></div>
              </div>

              <div id="import-errors" class="alert alert-danger mt-3 d-none" role="alert" aria-live="assertive"></div>

              <div class="d-flex justify-content-end mt-3">
                <button type="submit" class="btn btn-success">
                  <i class="bi bi-upload"></i> Enviar e importar
                </button>
              </div>
            </form>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<div id="loading-overlay" class="message-overlay" style="display:none;">
  <div class="message-box text-center">
    <div class="d-flex justify-content-center mb-3">
      <div class="spinner-border" role="status" aria-hidden="true"></div>
    </div>
    <h5 class="mb-2">Importando empresas…</h5>
    <p class="text-muted mb-0">Isso pode levar alguns segundos. Não feche a página.</p>
  </div>
</div>


{% block extra_js %}
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
  <script src="{% static 'js/site/cadastrar_empresa.js' %}"></script>
{% endblock %}

{% endblock %}