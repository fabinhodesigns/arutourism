{% extends 'base2.html' %}
{% block title %}Cadastrar Empresa{% endblock %}
{% load widget_tweaks %}
{% load form_helpers %}

{% block content %}

<style>
  .toast-notification{position:fixed;top:80px;right:20px;background:#28a745;color:#fff;padding:1rem 1.5rem;border-radius:8px;font-weight:500;box-shadow:0 4px 15px rgba(0,0,0,.2);z-index:1060;opacity:0;transform:translateY(-20px);pointer-events:none;transition:all .4s}
  .toast-notification.show{opacity:1;transform:translateY(0);pointer-events:auto}
  .message-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);display:flex;justify-content:center;align-items:flex-start;padding-top:50px;z-index:1050}
  .message-box{background:#fff;padding:1.5rem 2rem;border-radius:12px;width:90%;max-width:520px;box-shadow:0 5px 20px rgba(0,0,0,.25);animation:slide-down .35s ease-out}
  @keyframes slide-down{from{transform:translateY(-30px);opacity:0}to{transform:translateY(0);opacity:1}}

  /* abas */
  .nav-tabs .nav-link{font-weight:600}
  .nav-tabs .nav-link.active{color:#1e3c72}
  .import-drop{border:2px dashed #cbd5e1;border-radius:12px;padding:2rem;background:#f8fafc;text-align:center}
  .import-drop.drag{background:#eef2ff;border-color:#93c5fd}
  .spinner-lg{width:2rem;height:2rem;border:.3rem solid #fff;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* card uniform */
  .card-clean{border-radius:14px;box-shadow:0 10px 30px rgba(2,6,23,.06)}

  .import-drop{border:2px dashed #cbd5e1;border-radius:12px;padding:2rem;background:#f8fafc;text-align:center}
  .import-drop.drag{background:#eef2ff;border-color:#93c5fd}
  .import-drop.invalid{background:#fff5f5;border-color:#dc3545}
</style>

<div id="notification-container"></div>

<div class="container py-5 mt-5">
  <div class="row justify-content-center">
    <div class="col-lg-10 col-md-11 col-12">

      <!-- Título -->
      <h3 class="text-center fw-bold mb-4">Cadastro de Empresas</h3>

      <!-- Abas -->
      <ul class="nav nav-tabs justify-content-center mb-4" id="cadTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="tab-individual" data-bs-toggle="tab" data-bs-target="#pane-individual" type="button" role="tab" aria-controls="pane-individual" aria-selected="true">
            Cadastro Individual
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-arquivo" data-bs-toggle="tab" data-bs-target="#pane-arquivo" type="button" role="tab" aria-controls="pane-arquivo" aria-selected="false">
            Cadastro com Arquivo
          </button>
        </li>
      </ul>

      <div class="tab-content">

        <!-- PANE 1: CADASTRO INDIVIDUAL -->
        <div class="tab-pane fade show active" id="pane-individual" role="tabpanel" aria-labelledby="tab-individual">
          <div class="card card-clean p-4 bg-white">

            {% if form.errors %}
            <div id="errors-from-server" class="mb-3">
              <div class="message-box">
                <h5>Por favor, corrija os seguintes erros:</h5>
                <ul>
                  {% for field, error_list in form.errors.items %}
                    {% for error in error_list %}
                      <li>{% if field != '__all__' %}<strong>{{ form|get_field_verbose_name:field }}:</strong>{% endif %} {{ error }}</li>
                    {% endfor %}
                  {% endfor %}
                </ul>
              </div>
            </div>
            {% endif %}

            <form id="empresa-form" method="POST" enctype="multipart/form-data">
              {% csrf_token %}
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="{{ form.nome.id_for_label }}" class="form-label fw-semibold">Nome da Empresa</label>
                  {{ form.nome|add_class:"form-control form-control-lg" }}
                </div>
                <div class="col-md-6">
                  <label for="{{ form.categoria.id_for_label }}" class="form-label fw-semibold">Categoria</label>
                  {{ form.categoria|add_class:"form-select form-select-lg" }}
                </div>

                <div class="col-12">
                  <label for="{{ form.descricao.id_for_label }}" class="form-label fw-semibold">Descrição</label>
                  {{ form.descricao|add_class:"form-control form-control-lg" }}
                  <small class="text-muted">Se deixar em branco, colocaremos uma descrição padrão automaticamente.</small>
                </div>

                <div class="col-md-6">
                  <label for="{{ form.rua.id_for_label }}" class="form-label fw-semibold">Rua</label>
                  {{ form.rua|add_class:"form-control form-control-lg" }}
                </div>
                <div class="col-md-6">
                  <label for="{{ form.bairro.id_for_label }}" class="form-label fw-semibold">Bairro</label>
                  {{ form.bairro|add_class:"form-control form-control-lg" }}
                </div>

                <div class="col-md-6">
                  <label for="{{ form.cidade.id_for_label }}" class="form-label fw-semibold">Cidade</label>
                  {{ form.cidade|add_class:"form-control form-control-lg" }}
                </div>
                <div class="col-md-3">
                  <label for="{{ form.numero.id_for_label }}" class="form-label fw-semibold">Número</label>
                  {{ form.numero|add_class:"form-control form-control-lg" }}
                </div>
                <div class="col-md-3">
                  <label for="{{ form.cep.id_for_label }}" class="form-label fw-semibold">CEP</label>
                  {{ form.cep|add_class:"form-control form-control-lg" }}
                </div>

                <div class="col-md-6">
                  <label for="{{ form.telefone.id_for_label }}" class="form-label fw-semibold">Telefone</label>
                  {{ form.telefone|add_class:"form-control form-control-lg" }}
                  <div class="form-check form-check-inline mt-1">
                    {{ form.sem_telefone|add_class:"form-check-input" }}
                    <label class="form-check-label" for="{{ form.sem_telefone.id_for_label }}">Sem Telefone</label>
                  </div>
                </div>
                <div class="col-md-6">
                  <label for="{{ form.email.id_for_label }}" class="form-label fw-semibold">Email de Contato</label>
                  {{ form.email|add_class:"form-control form-control-lg" }}
                  <div class="form-check form-check-inline mt-1">
                    {{ form.sem_email|add_class:"form-check-input" }}
                    <label class="form-check-label" for="{{ form.sem_email.id_for_label }}">Sem Email</label>
                  </div>
                </div>

                <div class="col-12">
                  <label for="{{ form.site.id_for_label }}" class="form-label fw-semibold">Site (opcional)</label>
                  {{ form.site|add_class:"form-control form-control-lg" }}
                </div>

                <div class="col-12">
                  <label for="{{ form.imagem.id_for_label }}" class="form-label fw-semibold">Imagem da Empresa</label>
                  {{ form.imagem|add_class:"form-control form-control-sm" }}
                  <small class="form-text text-muted fst-italic mt-1">Você pode enviar uma imagem da empresa.</small>
                </div>

                {{ form.latitude }} {{ form.longitude }}

                <div class="col-md-6">
                  <label for="{{ form.facebook.id_for_label }}" class="form-label fw-semibold">Facebook</label>
                  {{ form.facebook|add_class:"form-control form-control-lg" }}
                </div>
                <div class="col-md-6">
                  <label for="{{ form.instagram.id_for_label }}" class="form-label fw-semibold">Instagram</label>
                  {{ form.instagram|add_class:"form-control form-control-lg" }}
                </div>

                <div class="col-12 mt-3">
                  <label class="form-label fw-semibold">Selecione a localização no mapa</label>
                  <div id="map" style="height: 380px; border-radius: 10px;"></div>
                </div>
              </div>

              <div class="d-flex flex-column flex-md-row gap-3 justify-content-center mt-4">
                <button type="submit" name="save" class="btn btn-primary btn-lg rounded-3 fw-semibold px-4">Salvar</button>
                <button type="submit" name="save_and_add" class="btn btn-outline-secondary btn-lg rounded-3 fw-semibold px-4">Salvar e Continuar</button>
              </div>
            </form>
          </div>
        </div>

        <!-- PANE 2: CADASTRO COM ARQUIVO -->
        <div class="tab-pane fade" id="pane-arquivo" role="tabpanel" aria-labelledby="tab-arquivo">
          <div class="card card-clean p-4 bg-white">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
              <h5 class="mb-0 fw-bold">Importar empresas por arquivo (.xlsx / .csv)</h5>
              <a class="btn btn-outline-secondary btn-sm" href="{% url 'download_template_empresas' %}">
                Baixar modelo (.xlsx)
            </a>
            </div>

            <p class="text-muted mb-3">
              Preencha o arquivo seguindo os cabeçalhos do modelo. Campos vazios serão preenchidos com valores padrão
              (ex.: descrição). A categoria será criada automaticamente se não existir.
            </p>

            <form id="form-import" method="post" enctype="multipart/form-data" action="{% url 'importar_empresas_arquivo' %}">
              <div id="import-errors" class="alert alert-danger mt-3 d-none"></div>
              {% csrf_token %}
              <div id="drop" class="import-drop">
                <input id="arquivo" name="arquivo" type="file" accept=".xlsx,.csv" hidden>
                <p class="mb-2">Arraste e solte seu arquivo aqui, ou</p>
                <button type="button" id="btn-select" class="btn btn-secondary">Selecionar arquivo</button>
                <div id="fn" class="mt-2 small text-muted"></div>
              </div>

              <div class="d-flex justify-content-end mt-3">
                <button type="submit" class="btn btn-success">
                  <i class="bi bi-upload"></i> Enviar e importar
                </button>
              </div>
            </form>
          </div>
        </div>

      </div> <!-- /.tab-content -->
    </div>
  </div>
</div>

<!-- Loading fullscreen (reutilizável) -->
<div id="loading-overlay" class="message-overlay" style="display:none;">
  <div class="message-box text-center">
    <div class="d-flex justify-content-center mb-3">
      <div class="spinner-lg"></div>
    </div>
    <h5 class="mb-2">Importando empresas…</h5>
    <p class="text-muted mb-0">Isso pode levar alguns segundos. Não feche a página.</p>
  </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
(function(){

  // ===== Util: toast =====
  function toast(message, danger){
    const t = document.createElement('div');
    t.className = 'toast-notification' + (danger ? ' bg-danger' : '');
    t.textContent = message;
    document.getElementById('notification-container')?.appendChild(t);
    setTimeout(()=> t.classList.add('show'), 30);
    setTimeout(()=> { t.classList.remove('show'); setTimeout(()=> t.remove(), 350); }, 3500);
  }

  // ===== MAPA (só liga se existir) =====
  let map, marker;
  const $map = document.getElementById('map');
  if ($map){
    // Leaflet precisa estar carregado nessa página
    try{
      map = L.map('map').setView([-28.9371, -49.4840], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
      map.on('click', function(e){
        if (marker) map.removeLayer(marker);
        marker = L.marker(e.latlng).addTo(map);
        const lat = document.getElementById('id_latitude');
        const lng = document.getElementById('id_longitude');
        if (lat) lat.value = e.latlng.lat.toFixed(6);
        if (lng) lng.value = e.latlng.lng.toFixed(6);
      });
    }catch(_e){ /* Leaflet não carregado nesta view; ignora */ }
  }

  // ===== Máscara simples de CEP =====
  const cep = document.getElementById('id_cep');
  if (cep){
    cep.addEventListener('input', function(){
      this.value = this.value.replace(/\D/g,'').slice(0,8);
    });
  }

  // ===== Habilita/desabilita telefone/e-mail =====
  function toggleFields(){
    const tel = document.getElementById('id_telefone');
    const semTel = document.getElementById('id_sem_telefone');
    if (tel && semTel) tel.disabled = semTel.checked;

    const em = document.getElementById('id_email');
    const semEm = document.getElementById('id_sem_email');
    if (em && semEm) em.disabled = semEm.checked;
  }
  const semTel = document.getElementById('id_sem_telefone');
  const semEm = document.getElementById('id_sem_email');
  if (semTel) semTel.addEventListener('change', toggleFields);
  if (semEm) semEm.addEventListener('change', toggleFields);
  toggleFields();

  // ===== Cadastro Individual (AJAX) =====
  const formEmpresa = document.getElementById('empresa-form');
  if (formEmpresa){
    formEmpresa.addEventListener('submit', async function(e){
      e.preventDefault();
      const fd = new FormData(formEmpresa);
      const submitter = e.submitter;
      if (submitter && submitter.name) fd.append(submitter.name, submitter.value);

      // limpa notificações
      const notif = document.getElementById('notification-container');
      if (notif) notif.innerHTML = '';

      try{
        const resp = await fetch(formEmpresa.action || window.location.pathname, {
          method:'POST',
          body: fd,
          headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        });

        if (resp.ok){
          // deve vir JSON
          const data = await resp.json();
          toast(data.message || 'Salvo com sucesso!');
          if (data.action === 'redirect'){
            setTimeout(()=> location.href = data.redirect_url || "{% url 'listar_empresas' %}", 1200);
          }else{
            formEmpresa.reset();
            if (marker && map){ map.removeLayer(marker); marker = null; }
          }
        }else{
          // pode vir HTML (template com erros) ou JSON
          const text = await resp.text();
          try{
            const asJson = JSON.parse(text);
            toast(asJson.error || 'Erro ao salvar.', true);
          }catch{
            const doc = new DOMParser().parseFromString(text, 'text/html');
            const src = doc.querySelector('#errors-from-server');
            const container = document.getElementById('notification-container');
            if (src && container){
              container.innerHTML = src.innerHTML;
            }else{
              toast('Erro inesperado ao salvar.', true);
            }
          }
        }
      }catch(err){
        toast('Falha de conexão. Tente novamente.', true);
      }
    });
  }

  // ===== Importação por arquivo (.xlsx/.csv) =====
  const drop = document.getElementById('drop');
  const inp  = document.getElementById('arquivo');
  const btn  = document.getElementById('btn-select');
  const fn   = document.getElementById('fn');
  const loading = document.getElementById('loading-overlay');
  const formImport = document.getElementById('form-import');

  // só liga tudo se os elementos existem nesta página
  if (drop && inp && btn && fn && formImport){

    function clearErrorBox(){
      drop.classList.remove('drag');
      drop.classList.remove('has-error');
      drop.style.borderColor = '';
      drop.style.background = '';
    }
    function markErrorBox(){
      drop.classList.add('has-error');
      // fallback visual imediato mesmo sem CSS extra:
      drop.style.borderColor = '#dc3545';
      drop.style.background = '#fff5f5';
    }

    btn.addEventListener('click', ()=> inp.click());
    inp.addEventListener('change', ()=>{
      fn.textContent = inp.files[0] ? inp.files[0].name : '';
      clearErrorBox();
    });

    ['dragenter','dragover'].forEach(evt=>{
      drop.addEventListener(evt, e=>{
        e.preventDefault(); e.stopPropagation();
        drop.classList.add('drag');
      });
    });
    ['dragleave','drop'].forEach(evt=>{
      drop.addEventListener(evt, e=>{
        e.preventDefault(); e.stopPropagation();
        drop.classList.remove('drag');
      });
    });
    drop.addEventListener('drop', e=>{
      const file = e.dataTransfer.files && e.dataTransfer.files[0];
      if (file){
        inp.files = e.dataTransfer.files;
        fn.textContent = file.name;
        clearErrorBox();
      }
    });

    formImport.addEventListener('submit', async function(e){
      e.preventDefault();
      if (!inp.files.length){
        markErrorBox();
        toast('Selecione um arquivo primeiro.', true);
        return;
      }

      if (loading) loading.style.display = 'flex';
      try{
        const fd = new FormData(formImport);
        const resp = await fetch(formImport.action, {
          method:'POST',
          body: fd,
          headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        });

        if (loading) loading.style.display = 'none';

        // Tenta JSON sempre; se não der, pega texto
        let payload, raw = null;
        try{
          payload = await resp.json();
        }catch(_e){
          raw = await resp.text();
        }

        if (resp.ok && payload && (payload.ok === true || payload.importados !== undefined)){
          const ok = payload.importados ?? 0;
          const err = payload.erros ?? 0;
          const msgs = payload.mensagens ?? [];
          if (err > 0){
            // não redireciona; mostra erros
            markErrorBox();
            const top = msgs.slice(0, 10).join(' | ');
            toast(`Ocorreram erros (${err}). ${top}`, true);
            return; // ← não redireciona em caso de erro
          }
          // sucesso: pode redirecionar
          toast(`Importação concluída: ${ok} registro(s).`);
          if (payload.redirect){
            setTimeout(()=> location.href = payload.redirect_url || "{% url 'listar_empresas' %}", 1200);
          }
        }else{
          // Falhou (400/500). Mostra mensagem vinda do servidor ou fallback
          markErrorBox();
          if (payload && (payload.error || payload.msg)){
            toast(payload.error || payload.msg, true);
          }else if (raw){
            toast('Falha ao importar (servidor retornou erro).', true);
            console.error('Import error raw response:', raw);
          }else{
            toast('Falha ao importar.', true);
          }
        }
      }catch(err){
        if (loading) loading.style.display = 'none';
        markErrorBox();
        toast('Falha de conexão ao importar.', true);
      }
    });
  }

})();
</script>
{% endblock %}