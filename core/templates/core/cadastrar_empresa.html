{% extends 'base2.html' %}
{% load widget_tweaks %}
{% load form_helpers %}
{% load static %}

{% block title %}Cadastrar Empresa{% endblock %}

{% block content %}
<style>
  .toast-notification{position:fixed;top:80px;right:20px;background:#28a745;color:#fff;padding:1rem 1.5rem;border-radius:8px;font-weight:500;box-shadow:0 4px 15px rgba(0,0,0,.2);z-index:1060;opacity:0;transform:translateY(-20px);pointer-events:none;transition:all .4s}
  .toast-notification.show{opacity:1;transform:translateY(0);pointer-events:auto}
  .message-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);display:flex;justify-content:center;align-items:flex-start;padding-top:50px;z-index:1050}
  .message-box{background:#fff;padding:1.5rem 2rem;border-radius:12px;width:90%;max-width:560px;box-shadow:0 5px 20px rgba(0,0,0,.25);animation:slide-down .35s ease-out}
  @keyframes slide-down{from{transform:translateY(-30px);opacity:0}to{transform:translateY(0);opacity:1}}
  .card-clean{border-radius:14px;box-shadow:0 10px 30px rgba(2,6,23,.06)}
  .import-drop{border:2px dashed #cbd5e1;border-radius:12px;padding:2rem;background:#f8fafc;text-align:center;transition:.2s}
  .import-drop.drag{background:#eef2ff;border-color:#93c5fd}
  .import-drop.border-danger{background:#fff5f5;border-color:#dc3545}
  .preview-wrap{border:1px dashed #dee2e6;border-radius:10px;padding:10px;display:flex;gap:14px;align-items:center}
  .preview-wrap img{max-height:80px;border-radius:6px;object-fit:cover}
  .sr-only{position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
</style>

<div id="notification-container" aria-live="polite" aria-atomic="true"></div>

<div class="container py-5 mt-5">
  <div class="row justify-content-center">
    <div class="col-lg-10 col-md-11 col-12">

      <h3 class="text-center fw-bold mb-4">Cadastro de Empresas</h3>

      <ul class="nav nav-tabs justify-content-center mb-4" id="cadTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="tab-individual" data-bs-toggle="tab" data-bs-target="#pane-individual" type="button" role="tab" aria-controls="pane-individual" aria-selected="true">
            Cadastro Individual
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-arquivo" data-bs-toggle="tab" data-bs-target="#pane-arquivo" type="button" role="tab" aria-controls="pane-arquivo" aria-selected="false">
            Cadastro com Arquivo
          </button>
        </li>
      </ul>

      <div class="tab-content">

        <!-- CADASTRO INDIVIDUAL -->
        <div class="tab-pane fade show active" id="pane-individual" role="tabpanel" aria-labelledby="tab-individual">
          <div class="card card-clean p-4 bg-white">

            {% if form.errors %}
            <div id="errors-from-server" class="mb-3" role="alert" aria-live="assertive">
              <div class="message-box">
                <h5 class="mb-2">Por favor, corrija os seguintes erros:</h5>
                <ul class="m-0">
                  {% for field, error_list in form.errors.items %}
                    {% for error in error_list %}
                      <li>{% if field != '__all__' %}<strong>{{ form|get_field_verbose_name:field }}:</strong>{% endif %} {{ error }}</li>
                    {% endfor %}
                  {% endfor %}
                </ul>
              </div>
            </div>
            {% endif %}

            <form id="empresa-form" method="POST" enctype="multipart/form-data" novalidate>
              {% csrf_token %}
              <div class="row g-3">

                <div class="col-md-6">
                  <label for="{{ form.nome.id_for_label }}" class="form-label fw-semibold">Nome da Empresa</label>
                  {{ form.nome|add_class:"form-control form-control-lg"|attr:"autocomplete:organization" }}
                </div>

                <div class="col-md-6">
                  <label for="{{ form.categoria.id_for_label }}" class="form-label fw-semibold">Categoria</label>
                  {{ form.categoria|add_class:"form-select form-select-lg" }}
                </div>

                <div class="col-12">
                  <label for="{{ form.descricao.id_for_label }}" class="form-label fw-semibold">Descrição</label>
                  {{ form.descricao|add_class:"form-control form-control-lg"|attr:"rows:3" }}
                  <small class="text-muted">Se deixar em branco, colocaremos uma descrição padrão automaticamente.</small>
                </div>

                <div class="col-md-6">
                  <label for="{{ form.rua.id_for_label }}" class="form-label fw-semibold">Rua</label>
                  {{ form.rua|add_class:"form-control form-control-lg"|attr:"autocomplete:address-line1" }}
                </div>
                <div class="col-md-6">
                  <label for="{{ form.bairro.id_for_label }}" class="form-label fw-semibold">Bairro</label>
                  {{ form.bairro|add_class:"form-control form-control-lg"|attr:"autocomplete:address-level3" }}
                </div>

                <div class="col-md-6">
                  <label for="{{ form.cidade.id_for_label }}" class="form-label fw-semibold">Cidade</label>
                  {{ form.cidade|add_class:"form-control form-control-lg"|attr:"autocomplete:address-level2" }}
                </div>
                <div class="col-md-3">
                  <label for="{{ form.numero.id_for_label }}" class="form-label fw-semibold">Número</label>
                  {{ form.numero|add_class:"form-control form-control-lg"|attr:"inputmode:numeric" }}
                </div>
                <div class="col-md-3">
                  <label for="{{ form.cep.id_for_label }}" class="form-label fw-semibold">CEP</label>
                  {{ form.cep|add_class:"form-control form-control-lg"|attr:"inputmode:numeric" }}
                </div>

                <div class="col-md-6">
                  <label for="{{ form.telefone.id_for_label }}" class="form-label fw-semibold">Telefone</label>
                  {{ form.telefone|add_class:"form-control form-control-lg"|attr:"inputmode:tel" }}
                  <div class="form-check form-check-inline mt-1">
                    {{ form.sem_telefone|add_class:"form-check-input" }}
                    <label class="form-check-label" for="{{ form.sem_telefone.id_for_label }}">Sem Telefone</label>
                  </div>
                </div>

                <div class="col-md-6">
                  <label for="{{ form.email.id_for_label }}" class="form-label fw-semibold">Email de Contato</label>
                  {{ form.email|add_class:"form-control form-control-lg"|attr:"inputmode:email" }}
                  <div class="form-check form-check-inline mt-1">
                    {{ form.sem_email|add_class:"form-check-input" }}
                    <label class="form-check-label" for="{{ form.sem_email.id_for_label }}">Sem Email</label>
                  </div>
                </div>

                <div class="col-12">
                  <label for="{{ form.site.id_for_label }}" class="form-label fw-semibold">Site (opcional)</label>
                  {{ form.site|add_class:"form-control form-control-lg"|attr:"inputmode:url" }}
                </div>

                <div class="col-12">
                  <label for="{{ form.imagem.id_for_label }}" class="form-label fw-semibold">Imagem da Empresa</label>
                  <div class="preview-wrap">
                    <img id="img-preview" src="{% static 'core/images/sem_imagem.png' %}" alt="Pré-visualização da imagem" />
                    {{ form.imagem|add_class:"form-control form-control-sm" }}
                  </div>
                  <small class="form-text text-muted fst-italic mt-1">Pré-visualize a imagem antes de salvar.</small>
                </div>

                {{ form.latitude }} {{ form.longitude }}

                <div class="col-md-6">
                  <label for="{{ form.facebook.id_for_label }}" class="form-label fw-semibold">Facebook (opcional)</label>
                  {{ form.facebook|add_class:"form-control form-control-lg"|attr:"inputmode:url" }}
                </div>
                <div class="col-md-6">
                  <label for="{{ form.instagram.id_for_label }}" class="form-label fw-semibold">Instagram (opcional)</label>
                  {{ form.instagram|add_class:"form-control form-control-lg"|attr:"inputmode:url" }}
                </div>

                <!-- bloco avançado (mostra todos os campos adicionais do form, se existirem) -->
                {% if form.fields.cnpj or form.fields.cadastrur or form.fields.digital or form.fields.maps_url or form.fields.app_url or form.fields.endereco_full %}
                <div class="col-12">
                  <hr class="my-3" aria-hidden="true">
                  <h5 class="fw-semibold mb-2">Dados avançados</h5>
                </div>
                {% if form.fields.cnpj %}
                <div class="col-md-4">
                  <label for="{{ form.cnpj.id_for_label }}" class="form-label fw-semibold">CNPJ</label>
                  {{ form.cnpj|add_class:"form-control form-control-lg"|attr:"inputmode:numeric" }}
                </div>
                {% endif %}
                {% if form.fields.cadastrur %}
                <div class="col-md-4">
                  <label for="{{ form.cadastrur.id_for_label }}" class="form-label fw-semibold">Cadastur</label>
                  {{ form.cadastrur|add_class:"form-control form-control-lg" }}
                </div>
                {% endif %}
                {% if form.fields.endereco_full %}
                <div class="col-md-4">
                  <label for="{{ form.endereco_full.id_for_label }}" class="form-label fw-semibold">Endereço completo</label>
                  {{ form.endereco_full|add_class:"form-control form-control-lg" }}
                </div>
                {% endif %}
                {% if form.fields.digital %}
                <div class="col-md-6">
                  <label for="{{ form.digital.id_for_label }}" class="form-label fw-semibold">Digital (site/redes)</label>
                  {{ form.digital|add_class:"form-control form-control-lg"|attr:"inputmode:url" }}
                </div>
                {% endif %}
                {% if form.fields.maps_url %}
                <div class="col-md-6">
                  <label for="{{ form.maps_url.id_for_label }}" class="form-label fw-semibold">Google Maps (link)</label>
                  {{ form.maps_url|add_class:"form-control form-control-lg"|attr:"inputmode:url" }}
                </div>
                {% endif %}
                {% if form.fields.app_url %}
                <div class="col-md-6">
                  <label for="{{ form.app_url.id_for_label }}" class="form-label fw-semibold">App (link)</label>
                  {{ form.app_url|add_class:"form-control form-control-lg"|attr:"inputmode:url" }}
                </div>
                {% endif %}
                {% endif %}

                <div class="col-12 mt-3">
                  <label class="form-label fw-semibold">Selecione a localização no mapa</label>
                  <div id="map" style="height: 380px; border-radius: 10px;"></div>
                </div>
              </div>

              <div class="d-flex flex-column flex-md-row gap-3 justify-content-center mt-4">
                <button type="submit" name="save" class="btn btn-primary btn-lg rounded-3 fw-semibold px-4">Salvar</button>
                <button type="submit" name="save_and_add" class="btn btn-outline-secondary btn-lg rounded-3 fw-semibold px-4">Salvar e Continuar</button>
              </div>
            </form>
          </div>
        </div>

        <!-- CADASTRO COM ARQUIVO -->
        <div class="tab-pane fade" id="pane-arquivo" role="tabpanel" aria-labelledby="tab-arquivo">
          <div class="card card-clean p-4 bg-white">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
              <h5 class="mb-0 fw-bold">Importar empresas por arquivo (.xlsx / .csv)</h5>
              <a class="btn btn-outline-secondary btn-sm" href="{% url 'download_template_empresas' %}">
                Baixar modelo (.xlsx)
              </a>
            </div>

            <p class="text-muted mb-3">
              Preencha o arquivo seguindo os cabeçalhos do modelo. Campos vazios serão preenchidos com valores padrão
              (ex.: descrição). A categoria será criada automaticamente se não existir.
            </p>

            <form id="form-import" method="post" enctype="multipart/form-data" action="{% url 'importar_empresas_arquivo' %}">
              {% csrf_token %}
              <div id="drop" class="import-drop" role="region" aria-label="Envio de arquivo por arrastar e soltar">
                <input id="arquivo" name="arquivo" type="file" accept=".xlsx,.csv" hidden>
                <p class="mb-2">Arraste e solte seu arquivo aqui, ou</p>
                <button type="button" id="btn-select" class="btn btn-secondary">Selecionar arquivo</button>
                <div id="fn" class="mt-2 small text-muted" aria-live="polite"></div>
              </div>

              <div id="import-errors" class="alert alert-danger mt-3 d-none" role="alert" aria-live="assertive"></div>

              <div class="d-flex justify-content-end mt-3">
                <button type="submit" class="btn btn-success">
                  <i class="bi bi-upload"></i> Enviar e importar
                </button>
              </div>
            </form>
          </div>
        </div>

      </div> <!-- /.tab-content -->
    </div>
  </div>
</div>

<!-- Loading fullscreen -->
<div id="loading-overlay" class="message-overlay" style="display:none;">
  <div class="message-box text-center">
    <div class="d-flex justify-content-center mb-3">
      <div class="spinner-border" role="status" aria-hidden="true"></div>
    </div>
    <h5 class="mb-2">Importando empresas…</h5>
    <p class="text-muted mb-0">Isso pode levar alguns segundos. Não feche a página.</p>
  </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
(function(){
  // ====== MAPA ======
  let map, marker;
  const $map = $('#map');
  if ($map.length){
    map = L.map('map').setView([-28.9371, -49.4840], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'© OpenStreetMap' }).addTo(map);
    map.on('click', function(e){
      if (marker) map.removeLayer(marker);
      marker = L.marker(e.latlng, {keyboard:true}).addTo(map);
      $('#id_latitude').val(e.latlng.lat.toFixed(6));
      $('#id_longitude').val(e.latlng.lng.toFixed(6));
    });
  }

  // ====== IMAGEM: preview ======
  const inputImg = document.getElementById('id_imagem');
  const imgPrev  = document.getElementById('img-preview');
  if (inputImg && imgPrev){
    inputImg.addEventListener('change', () => {
      const f = inputImg.files && inputImg.files[0];
      if (!f) return;
      const url = URL.createObjectURL(f);
      imgPrev.src = url;
      imgPrev.onload = () => URL.revokeObjectURL(url);
    });
  }

  // ====== máscaras ======
  $('#id_cep').on('input', function(){ $(this).val($(this).val().replace(/\D/g,'').slice(0,8)); });
  function toggleFields(){
    $('#id_telefone').prop('disabled', $('#id_sem_telefone').is(':checked'));
    $('#id_email').prop('disabled', $('#id_sem_email').is(':checked'));
  }
  $('#id_sem_telefone,#id_sem_email').on('change', toggleFields); toggleFields();

  // ====== helpers: overlay ======
  function onEscClose(e){ if (e.key === 'Escape') hideOverlay(); }
  function hideOverlay(){
    const o = document.getElementById('form-errors-overlay');
    if (o){ o.remove(); document.removeEventListener('keydown', onEscClose); }
  }

  // Remove wrappers duplicados (message-overlay / message-box) do HTML vindo do servidor
  function sanitizeOverlayHtml(html){
    const tmp = document.createElement('div');
    tmp.innerHTML = (html || '').trim();

    // Se vier um overlay/box dentro, pega só o conteúdo interno
    const innerOverlay = tmp.querySelector('.message-overlay');
    if (innerOverlay) tmp.innerHTML = innerOverlay.innerHTML;

    const innerBox = tmp.querySelector('.message-box');
    if (innerBox) tmp.innerHTML = innerBox.innerHTML;

    // Se não houver um <h1..h6>, adiciona título padrão
    if (!tmp.querySelector('h1,h2,h3,h4,h5,h6')) {
      const title = document.createElement('h5');
      title.className = 'mb-2';
      title.textContent = 'Por favor, corrija os seguintes erros:';
      tmp.prepend(title);
    }
    return tmp.innerHTML;
  }

  function showOverlay(innerHtml){
    const wrap = document.createElement('div');
    wrap.id = 'form-errors-overlay';
    wrap.className = 'message-overlay';
    wrap.setAttribute('role','dialog');
    wrap.setAttribute('aria-modal','true');
    wrap.innerHTML = `
      <div class="message-box position-relative" role="document">
        <button type="button" class="btn-close" aria-label="Fechar" data-dismiss-overlay style="position:absolute;top:.5rem;right:.5rem;"></button>
        ${sanitizeOverlayHtml(innerHtml)}
      </div>
    `;
    // fechar clicando fora
    wrap.addEventListener('click', (e)=>{ if (e.target === wrap) hideOverlay(); });
    // fechar no X
    wrap.querySelector('[data-dismiss-overlay]').addEventListener('click', hideOverlay);
    // fechar com ESC
    document.addEventListener('keydown', onEscClose);

    document.getElementById('notification-container').appendChild(wrap);
  }

  // ====== SUBMIT AJAX (individual) ======
  $('#empresa-form').on('submit', async function(e){
    e.preventDefault();
    const form = this;
    const fd = new FormData(form);
    const submitter = e.originalEvent && e.originalEvent.submitter;
    if (submitter && submitter.name) fd.append(submitter.name, submitter.value);

    let resp;
    try{
      resp = await fetch(form.action || window.location.pathname, {
        method:'POST',
        body: fd,
        headers:{ 'Accept':'application/json' }
      });
    }catch(err){
      return toast('Falha de conexão com o servidor. Tente novamente.', true);
    }

    // limpa notificações/overlays antigos
    $('#notification-container').empty();
    hideOverlay();

    if (resp.ok){
      let data = {};
      try { data = await resp.json(); } catch(_) {}
      toast(data.message || 'Salvo com sucesso!');
      const action = data.action || 'redirect';
      const redirect = data.redirect_url || '{% url "listar_empresas" %}';
      if (action === 'redirect'){
        setTimeout(()=> location.href = redirect, 900);
      }else{
        form.reset();
        if (marker){ map.removeLayer(marker); marker=null; }
        if (imgPrev) imgPrev.src = "{% static 'core/images/sem_imagem.png' %}";
      }
      return;
    }

    // --- ERRO ---
    const ct = (resp.headers.get('content-type') || '').toLowerCase();

    // JSON com html de erros
    if (ct.includes('application/json')) {
      let payload = null;
      try { payload = await resp.clone().json(); } catch(_){}
      if (payload){
        if (payload.html){ showOverlay(payload.html); return; }
        if (payload.error){ toast(payload.error, true); return; }
      }
    }

    // HTML completo (fallback): extrai #errors-from-server
    const html = await resp.text();
    const doc  = new DOMParser().parseFromString(html, 'text/html');
    const src  = doc.querySelector('#errors-from-server');
    showOverlay(src ? src.innerHTML : '<p>Não foi possível exibir os erros do formulário.</p>');
  });

  // ====== IMPORTAÇÃO (arquivo) — INALTERADO ======
  const drop = document.getElementById('drop');
  const fileInput  = document.getElementById('arquivo');
  const btnSelect  = document.getElementById('btn-select');
  const fileNameEl = document.getElementById('fn');
  const loading    = document.getElementById('loading-overlay');
  const importErrors = document.getElementById('import-errors');

  if (btnSelect) btnSelect.addEventListener('click', ()=> fileInput && fileInput.click());
  if (fileInput) fileInput.addEventListener('change', ()=> {
    fileNameEl.textContent = fileInput.files[0] ? fileInput.files[0].name : '';
  });

  if (drop){
    ['dragenter','dragover'].forEach(evt=> drop.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); drop.classList.add('drag'); }));
    ['dragleave','drop'].forEach(evt=> drop.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); drop.classList.remove('drag'); }));
    drop.addEventListener('drop', e=>{
      const file = e.dataTransfer.files && e.dataTransfer.files[0];
      if (file && fileInput){ fileInput.files = e.dataTransfer.files; fileNameEl.textContent = file.name; }
    });
  }

  $('#form-import').on('submit', async function(e){
    e.preventDefault();
    if (!fileInput || !fileInput.files.length){
      drop && drop.classList.add('border-danger');
      showErrors(['Selecione um arquivo primeiro.']);
      return;
    }

    loading.style.display = 'flex';
    let resp;
    try{
      const fd = new FormData(this);
      resp = await fetch(this.action, { method:'POST', body: fd, headers:{ 'Accept':'application/json' } });
    }catch(err){
      loading.style.display = 'none';
      drop && drop.classList.add('border-danger');
      showErrors(['Falha de conexão com o servidor. Tente novamente.']);
      return;
    }
    loading.style.display = 'none';

    drop && drop.classList.remove('border-danger');
    hideErrors();

    if (resp.ok){
      const data = await resp.json();
      toast(`Importação concluída: ${data.importados} registro(s).`);
      if (data.redirect){ setTimeout(()=> location.href = data.redirect_url || '{% url "listar_empresas" %}', 900); }
    }else{
      drop && drop.classList.add('border-danger');
      let payload = null;
      try{ payload = await resp.json(); }catch(_){}
      if (payload){
        const msgs = payload.mensagens && payload.mensagens.length ? payload.mensagens : [payload.error || 'Falha ao importar.'];
        showErrors(msgs);
      }else{
        showErrors(['Falha ao importar. Verifique o arquivo e tente novamente.']);
      }
    }
  });

  function showErrors(list){
    if (!importErrors) return;
    importErrors.classList.remove('d-none');
    importErrors.innerHTML =
      `<strong>Ocorreram erros na importação:</strong>
       <ul class="mt-2 mb-0">${list.slice(0,100).map(m=>`<li>${m}</li>`).join('')}</ul>
       <p class="mt-2 mb-0 text-muted">Se o problema persistir, contate o suporte.</p>`;
    importErrors.focus();
  }
  function hideErrors(){
    if (!importErrors) return;
    importErrors.classList.add('d-none');
    importErrors.innerHTML = '';
  }

  // ====== toast ======
  function toast(message, danger){
    const t = document.createElement('div');
    t.className = 'toast-notification' + (danger ? ' bg-danger' : '');
    t.innerHTML = `<span>${message}</span><button type="button" class="btn-close ms-3" aria-label="Fechar"></button>`;
    t.querySelector('.btn-close').addEventListener('click', ()=> { t.classList.remove('show'); setTimeout(()=> t.remove(), 200); });
    document.getElementById('notification-container').appendChild(t);
    setTimeout(()=> t.classList.add('show'), 30);
    setTimeout(()=> { if (t.isConnected){ t.classList.remove('show'); setTimeout(()=> t.remove(), 300); } }, 4200);
  }
})();
</script>

{% endblock %}