{% extends 'base2.html' %}
{% load static %}
{% block title %}Definir nova senha{% endblock %}

{% block content %}
<style>
  /* Espaçamento e visual geral da página */
  .prc-hero {
    background: linear-gradient(180deg, rgba(30,60,114,.06), rgba(30,60,114,0));
    border-radius: 1rem;
    padding: clamp(1rem, 2vw, 2rem);
    margin-bottom: 1.5rem;
  }
  .prc-card {
    border: 0;
    border-radius: 1rem;
    padding: clamp(1.25rem, 2vw, 2rem);
  }
  .prc-icon {
    width: 56px; height: 56px;
    display:inline-flex; align-items:center; justify-content:center;
    border-radius: 50%;
    background: rgba(13,110,253,.12);
  }
  .form-floating > label { color: #6c757d; }
  .help-hints {
    background: #f8f9fa;
    border: 1px dashed #dee2e6;
    border-radius: .75rem;
    padding: .75rem .9rem;
    font-size: .925rem;
  }
  .pw-toggle {
    cursor: pointer;
    user-select: none;
  }
  @media (min-width: 992px){
    .prc-container {
      max-width: 960px;
    }
  }
</style>

<div class="container prc-container py-5 mt-5">

  {% if validlink %}

    <div class="prc-hero">
      <div class="d-flex align-items-center gap-3">
        <span class="prc-icon">
          <i class="bi bi-shield-lock" style="font-size:1.4rem;color:#0d6efd;"></i>
        </span>
        <div>
          <h2 class="fw-bold mb-1">Definir nova senha</h2>
          <p class="text-muted mb-0">Crie uma nova senha segura para acessar sua conta.</p>
        </div>
      </div>
    </div>

    <div class="row g-4">
      <div class="col-12 col-lg-7">
        <form method="post" class="card shadow-sm prc-card">
          {% csrf_token %}

          {% if form.non_field_errors %}
            <div class="alert alert-danger" role="alert">
              {{ form.non_field_errors }}
            </div>
          {% endif %}

          <!-- Nova senha -->
          <div class="mb-3">
            <div class="form-floating position-relative">
              {{ form.new_password1.as_widget|safe }}
              <label for="{{ form.new_password1.id_for_label }}">Nova senha</label>
              <button type="button"
                      class="btn btn-sm btn-outline-secondary position-absolute top-50 end-0 translate-middle-y me-2 pw-toggle"
                      data-target-id="{{ form.new_password1.id_for_label }}">
                <i class="bi bi-eye"></i> <span class="d-none d-sm-inline">mostrar</span>
              </button>
            </div>
            {% if form.new_password1.errors %}
              <div class="invalid-feedback d-block">{{ form.new_password1.errors.0 }}</div>
            {% else %}
              <div class="form-text">Use letras maiúsculas/minúsculas, números e símbolos.</div>
            {% endif %}
          </div>

          <!-- Confirmar nova senha -->
          <div class="mb-3">
            <div class="form-floating position-relative">
              {{ form.new_password2.as_widget|safe }}
              <label for="{{ form.new_password2.id_for_label }}">Confirmar nova senha</label>
              <button type="button"
                      class="btn btn-sm btn-outline-secondary position-absolute top-50 end-0 translate-middle-y me-2 pw-toggle"
                      data-target-id="{{ form.new_password2.id_for_label }}">
                <i class="bi bi-eye"></i> <span class="d-none d-sm-inline">mostrar</span>
              </button>
            </div>
            {% if form.new_password2.errors %}
              <div class="invalid-feedback d-block">{{ form.new_password2.errors.0 }}</div>
            {% endif %}
          </div>

          <button class="btn btn-success w-100 py-2" type="submit">
            <i class="bi bi-check2-circle me-1"></i> Salvar nova senha
          </button>

          <div class="text-center mt-3">
            <a class="small" href="{% url 'login' %}">&larr; Voltar ao login</a>
          </div>
        </form>
      </div>

      <div class="col-12 col-lg-5">
        <div class="help-hints">
          <div class="d-flex align-items-center mb-2">
            <i class="bi bi-info-circle me-2"></i>
            <strong>Dicas de segurança</strong>
          </div>
          <ul class="mb-0 ps-3">
            <li>Mínimo recomendado de 8 caracteres.</li>
            <li>Misture letras, números e símbolos.</li>
            <li>Evite informações pessoais e senhas reutilizadas.</li>
          </ul>
        </div>
        <div class="card mt-3 shadow-sm prc-card">
          <div class="d-flex align-items-center">
            <i class="bi bi-lock-fill text-secondary me-2"></i>
            <div>
              <div class="fw-semibold">Link de redefinição único</div>
              <div class="text-muted small">
                Por segurança, o link funciona uma única vez e tem validade limitada.
                Depois de usar, acesse com sua nova senha.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  {% else %}
    <!-- Estado de link inválido/consumido -->
    <div class="row justify-content-center">
      <div class="col-12 col-md-10 col-lg-8">
        <div class="card border-0 shadow-sm prc-card text-center">
          <div class="mb-3">
            <img src="{% static 'images/link_expirado.svg' %}" alt="" style="height:88px; opacity:.95;">
          </div>
          <h3 class="fw-bold mb-2">Link inválido ou já utilizado</h3>
          <p class="text-muted mb-4">
            Para sua segurança, cada link de redefinição só pode ser usado uma vez
            e expira após um período de tempo.
          </p>
          <div class="d-flex flex-column flex-sm-row gap-2 justify-content-center">
            <a href="{% url 'login' %}" class="btn btn-primary">
              <i class="bi bi-box-arrow-in-right me-1"></i> Ir para o login
            </a>
            <a class="btn btn-outline-secondary" href="{% url 'esqueci_senha_email' %}">
              Pedir um novo link
            </a>
          </div>
        </div>
        <div class="text-center mt-3 text-muted small">
          Redirecionando para o login em instantes…
        </div>
      </div>
    </div>

    <script>
      setTimeout(function(){ window.location.href = "{% url 'login' %}"; }, 3000);
    </script>
  {% endif %}
</div>

<script>
  // Aplica classes Bootstrap nos inputs gerados pelo Django e liga o toggle de visibilidade
  (function(){
    // Estiliza inputs password
    document.querySelectorAll('input[type="password"]').forEach(function(i){
      i.classList.add('form-control');
      // para form-floating funcionar corretamente:
      if(!i.id){ i.id = 'pw-' + Math.random().toString(36).slice(2); }
      i.setAttribute('placeholder','••••••••');
      i.setAttribute('autocomplete','new-password');
    });

    // Botão de mostrar/ocultar
    document.querySelectorAll('.pw-toggle').forEach(function(btn){
      btn.addEventListener('click', function(){
        const targetId = this.getAttribute('data-target-id');
        const input = document.getElementById(targetId);
        if (!input) return;
        const isPw = input.type === 'password';
        input.type = isPw ? 'text' : 'password';
        const icon = this.querySelector('i');
        if (icon){
          icon.classList.toggle('bi-eye');
          icon.classList.toggle('bi-eye-slash');
        }
        const label = this.querySelector('span.d-none.d-sm-inline');
        if (label){
          label.textContent = isPw ? 'ocultar' : 'mostrar';
        }
        input.focus({ preventScroll: true });
      });
    });
  })();
</script>
{% endblock %}